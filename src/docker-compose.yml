name: router_service

services:

  PGROUTING:
    container_name: PGROUTING_DB
    image: pgrouting/pgrouting:16-3.4-3.6.1
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "5432:5432"
    volumes:
      - db-data:/var/lib/postgresql/data
      - ./OSM:/app/OSM:rw
      - ./OSMtools:/app/OSMtools:rw
      - ./PGExtensions:/app/PGExtensions:rw
    environment:
      POSTGRES_USER:      postgres
      POSTGRES_PASSWORD:  postgres
      POSTGRES_DB:        routing
    restart: always  # Garante que o banco de dados sempre ficarÃ¡ online
    networks:
      - pgrouting_network

  UPDATER:
    container_name: PGROUTING_UP_GRAPH
    image: pgrouting/pgrouting:16-3.4-3.6.1
    build:
      context: .
      dockerfile: Dockerfile
    deploy:
      resources:
        limits:
          memory: 9g
    volumes:
      - ./OSM:/app/OSM:rw
      - ./OSMtools:/app/OSMtools:rw
      - ./PGExtensions:/app/PGExtensions:rw
    depends_on:
      - PGROUTING
    command: >
      bash -c "su &&
               apt update &&
               apt list --upgradable &&
               apt -f install &&
               dpkg --configure -a &&
               apt-get install osmium-tool &&
               rm -f ./OSM/PROTOBUF/goias.pbf &&
               rm -f ./OSM/output_data_reduc.osm &&
               osmium extract -b -49.72,-15.44,-47.25,-17.01 ./OSM/PROTOBUF/centro-oeste-latest.osm.pbf -o ./OSM/PROTOBUF/goias.pbf &&
               chmod +x /app/OSMtools/osmconvert64 &&
               /app/OSMtools/osmconvert64 ./OSM/PROTOBUF/goias.pbf --drop-author --drop-version --drop-broken-ref --complete-ways --complete-multipolygons -o=./OSM/output_data_reduc.osm &&
               osm2pgrouting --f ./OSM/output_data_reduc.osm --conf ./osm2pgrouting-2.3.8/mapconfig.xml --host PGROUTING --dbname routing --username postgres --password postgres --port 5432 --addnodes --chunk 500 --clean"
    networks:
      - pgrouting_network

volumes:
  db-data:

networks:
  pgrouting_network:
    driver: bridge
