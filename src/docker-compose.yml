name: router_service
version: "3.9"

services:
  # Serviço para subir o banco de dados do psotgis
  pgrouting:
    container_name: PGROUTING_DB
    image: postgis/postgis:16-3.4
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "7533:5432" # direcianado para a porta externa
    volumes:
      - db-data:/var/lib/postgresql/data
    env_file: # usnado vairaveis de ambiente
      - .env
    restart: always # Garante que o banco de dados sempre ficará online
    networks:
      - pgrouting_network

  updater:
    container_name: PGROUTING_UP_GRAPH
    image: pgrouting/pgrouting:0.1
    build:
      context: .
      dockerfile: Dockerfile
    deploy: # Limitando o uso de memoria
      resources:
        limits:
          memory: 9g
    volumes:
      - data-osm:/src/OSMs
    depends_on:
      - pgrouting
    command: >
      bash -c "su && apt update && apt list --upgradable && apt -f install && dpkg --configure -a && apt-get install osmium-tool &&
               chmod +x ./OSMtools/osmconvert64 &&
               ls &&
               python main.py"
    networks:
      - pgrouting_network

#Volumes utilizados
volumes:
  db-data:
  data-osm:
    driver: local

networks:
  pgrouting_network:
    driver: bridge
